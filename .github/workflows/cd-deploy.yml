name: CricketTeamExpenseApp-CD - Deploy Infrastructure and Applications

on:
  workflow_run:
    workflows: ["CricketTeamExpenseApp-CI"]
    types:
      - completed
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

permissions:
  id-token: write
  contents: read

jobs:
  deploy-infrastructure:
    name: Deploy Azure Infrastructure
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    outputs:
      webAppName: ${{ steps.arm-deploy.outputs.webAppName }}
      webAppUrl: ${{ steps.arm-deploy.outputs.webAppUrl }}
      staticWebAppUrl: ${{ steps.arm-deploy.outputs.staticWebAppUrl }}
      sqlServerFqdn: ${{ steps.arm-deploy.outputs.sqlServerFqdn }}
      sqlDatabaseName: ${{ steps.arm-deploy.outputs.sqlDatabaseName }}
      appInsightsInstrumentationKey: ${{ steps.arm-deploy.outputs.appInsightsInstrumentationKey }}
      appInsightsConnectionString: ${{ steps.arm-deploy.outputs.appInsightsConnectionString }}
      staticWebAppToken: ${{ steps.get-swa-token.outputs.token }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Azure Login (OIDC)
      uses: azure/login@v1
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

    - name: Create Resource Group
      run: |
        az group create \
          --name cricket-expense-rg \
          --location eastasia

    - name: Deploy ARM Template
      id: arm-deploy
      uses: azure/arm-deploy@v1
      with:
        subscriptionId: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        resourceGroupName: cricket-expense-rg
        template: ./azure/azuredeploy.json
        parameters: ./azure/azuredeploy.parameters.json sqlAdministratorPassword=${{ secrets.SQL_ADMIN_PASSWORD }} jwtSecret=${{ secrets.JWT_SECRET }}
        deploymentName: 'cricketapp-${{ github.run_number }}'

    - name: Get Static Web App Deployment Token
      id: get-swa-token
      run: |
        echo "Retrieving Static Web App deployment token..."
        TOKEN=$(az staticwebapp secrets list \
          --name cricketteamexpense \
          --resource-group cricket-expense-rg \
          --query properties.apiKey \
          --output tsv)

        if [ -z "$TOKEN" ] || [ "$TOKEN" = "null" ]; then
          echo "‚ùå Failed to retrieve Static Web App token"
          exit 1
        fi

        echo "‚úÖ Token retrieved successfully"
        echo "::add-mask::$TOKEN"
        echo "token=$TOKEN" >> $GITHUB_OUTPUT

    - name: Deployment Summary
      run: |
        echo "### üèóÔ∏è Infrastructure Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Resource Group**: cricket-expense-rg" >> $GITHUB_STEP_SUMMARY
        echo "- **Region**: East Asia" >> $GITHUB_STEP_SUMMARY
        echo "- **Web App**: ${{ steps.arm-deploy.outputs.webAppName }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Backend URL**: ${{ steps.arm-deploy.outputs.webAppUrl }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Frontend URL**: https://${{ steps.arm-deploy.outputs.staticWebAppUrl }}" >> $GITHUB_STEP_SUMMARY
        echo "- **SQL Server**: ${{ steps.arm-deploy.outputs.sqlServerFqdn }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Database**: ${{ steps.arm-deploy.outputs.sqlDatabaseName }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "‚úÖ Infrastructure deployment completed!" >> $GITHUB_STEP_SUMMARY

  deploy-backend:
    name: Deploy Backend Application
    runs-on: ubuntu-latest
    needs: deploy-infrastructure
    environment:
      name: ${{ github.event.inputs.environment || 'production' }}
      url: ${{ needs.deploy-infrastructure.outputs.webAppUrl }}

    steps:
    - name: Download backend deployment artifact
      uses: dawidd6/action-download-artifact@v3
      with:
        workflow: ci.yml
        name: backend-deployment-package
        path: ./backend-deploy
        github_token: ${{ secrets.GITHUB_TOKEN }}
        commit: ${{ github.sha }}
        if_no_artifact_found: fail

    - name: Create deployment zip
      run: |
        cd backend-deploy
        zip -r ../deploy.zip . -x "*.db" -x "*.db-journal"
        cd ..
        ls -lh deploy.zip
        echo "‚úÖ Deployment package created with node_modules"

    - name: Azure Login (OIDC)
      uses: azure/login@v1
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

    - name: Upload package to Azure Storage (Run From Package)
      run: |
        # Check if storage account exists, create if not
        STORAGE_ACCOUNT=$(az storage account list -g cricket-expense-rg --query "[0].name" -o tsv)

        if [ -z "$STORAGE_ACCOUNT" ]; then
          echo "Creating storage account..."
          STORAGE_NAME="cricketdeploy$(date +%s)"
          az storage account create \
            --name $STORAGE_NAME \
            --resource-group cricket-expense-rg \
            --location eastasia \
            --sku Standard_LRS \
            --kind StorageV2
          STORAGE_ACCOUNT=$STORAGE_NAME
          echo "‚úÖ Storage account created: $STORAGE_ACCOUNT"
        else
          echo "‚úÖ Using existing storage account: $STORAGE_ACCOUNT"
        fi

        # Create container if it doesn't exist
        az storage container create \
          --name deployments \
          --account-name $STORAGE_ACCOUNT \
          --public-access off \
          --auth-mode login || true

        # Upload ZIP to blob storage with timestamp
        BLOB_NAME="backend-$(date +%Y%m%d-%H%M%S).zip"
        az storage blob upload \
          --account-name $STORAGE_ACCOUNT \
          --container-name deployments \
          --name $BLOB_NAME \
          --file deploy.zip \
          --auth-mode login \
          --overwrite

        # Generate SAS token valid for 1 year
        END_DATE=$(date -u -d "1 year" '+%Y-%m-%dT%H:%MZ' 2>/dev/null || date -u -v+1y '+%Y-%m-%dT%H:%MZ')
        SAS_TOKEN=$(az storage blob generate-sas \
          --account-name $STORAGE_ACCOUNT \
          --container-name deployments \
          --name $BLOB_NAME \
          --permissions r \
          --expiry $END_DATE \
          --https-only \
          --auth-mode login \
          -o tsv)

        BLOB_URL="https://${STORAGE_ACCOUNT}.blob.core.windows.net/deployments/${BLOB_NAME}"
        PACKAGE_URL="${BLOB_URL}?${SAS_TOKEN}"
        echo "PACKAGE_URL=$PACKAGE_URL" >> $GITHUB_ENV
        echo "‚úÖ Package uploaded to: $BLOB_URL"

    - name: Configure Run From Package
      run: |
        # Set WEBSITE_RUN_FROM_PACKAGE to use the uploaded ZIP
        az webapp config appsettings set \
          --name ${{ needs.deploy-infrastructure.outputs.webAppName }} \
          --resource-group cricket-expense-rg \
          --settings WEBSITE_RUN_FROM_PACKAGE="$PACKAGE_URL"

        echo "‚úÖ Run From Package configured"

    - name: Configure App Settings
      uses: azure/appservice-settings@v1
      with:
        app-name: ${{ needs.deploy-infrastructure.outputs.webAppName }}
        app-settings-json: |
          [
            {
              "name": "NODE_ENV",
              "value": "production",
              "slotSetting": false
            },
            {
              "name": "DB_TYPE",
              "value": "mssql",
              "slotSetting": false
            },
            {
              "name": "AZURE_SQL_SERVER",
              "value": "${{ needs.deploy-infrastructure.outputs.sqlServerFqdn }}",
              "slotSetting": false
            },
            {
              "name": "AZURE_SQL_DATABASE",
              "value": "${{ needs.deploy-infrastructure.outputs.sqlDatabaseName }}",
              "slotSetting": false
            },
            {
              "name": "AZURE_SQL_USER",
              "value": "sqladmin",
              "slotSetting": false
            },
            {
              "name": "AZURE_SQL_PASSWORD",
              "value": "${{ secrets.SQL_ADMIN_PASSWORD }}",
              "slotSetting": false
            },
            {
              "name": "JWT_SECRET",
              "value": "${{ secrets.JWT_SECRET }}",
              "slotSetting": false
            },
            {
              "name": "APPINSIGHTS_INSTRUMENTATION_KEY",
              "value": "${{ needs.deploy-infrastructure.outputs.appInsightsInstrumentationKey }}",
              "slotSetting": false
            },
            {
              "name": "APPLICATIONINSIGHTS_CONNECTION_STRING",
              "value": "${{ needs.deploy-infrastructure.outputs.appInsightsConnectionString }}",
              "slotSetting": false
            },
            {
              "name": "LOGGING_TYPE",
              "value": "applicationInsights",
              "slotSetting": false
            },
            {
              "name": "WEBSITE_NODE_DEFAULT_VERSION",
              "value": "~20",
              "slotSetting": false
            }
          ]

    - name: Restart Web App
      run: |
        az webapp restart \
          --name ${{ needs.deploy-infrastructure.outputs.webAppName }} \
          --resource-group cricket-expense-rg

    - name: Health Check
      run: |
        echo "Waiting for app to start..."
        sleep 30

        HEALTH_URL="${{ needs.deploy-infrastructure.outputs.webAppUrl }}/health"

        for i in {1..5}; do
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" $HEALTH_URL || echo "000")
          echo "Health check attempt $i: HTTP $HTTP_STATUS"

          if [ "$HTTP_STATUS" = "200" ]; then
            echo "‚úÖ Application is healthy!"

            # Get health check details
            HEALTH_RESPONSE=$(curl -s $HEALTH_URL || echo "")
            echo "Health check response: $HEALTH_RESPONSE"
            exit 0
          fi

          echo "Waiting 10 seconds before next attempt..."
          sleep 10
        done

        echo "‚ö†Ô∏è Health check did not return 200 status after 5 attempts"
        exit 1
      continue-on-error: false

    - name: Logout from Azure
      run: az logout
      if: always()

    - name: Deployment Summary
      run: |
        echo "### üöÄ Backend Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Environment**: ${{ github.event.inputs.environment || 'production' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **App Name**: ${{ needs.deploy-infrastructure.outputs.webAppName }}" >> $GITHUB_STEP_SUMMARY
        echo "- **URL**: ${{ needs.deploy-infrastructure.outputs.webAppUrl }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "‚úÖ Backend deployment completed successfully!" >> $GITHUB_STEP_SUMMARY

  deploy-frontend:
    name: Deploy Frontend Application
    runs-on: ubuntu-latest
    needs: deploy-infrastructure
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    environment:
      name: ${{ github.event.inputs.environment || 'production' }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Azure Login (OIDC)
      uses: azure/login@v1
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

    - name: Get Static Web App Deployment Token
      id: get-swa-token
      run: |
        echo "Retrieving Static Web App deployment token..."
        TOKEN=$(az staticwebapp secrets list \
          --name cricketteamexpense \
          --resource-group cricket-expense-rg \
          --query properties.apiKey \
          --output tsv)

        if [ -z "$TOKEN" ] || [ "$TOKEN" = "null" ]; then
          echo "‚ùå Failed to retrieve Static Web App token"
          exit 1
        fi

        echo "‚úÖ Token retrieved successfully"
        echo "::add-mask::$TOKEN"
        echo "token=$TOKEN" >> $GITHUB_OUTPUT

    - name: Download frontend deployment artifact
      uses: dawidd6/action-download-artifact@v3
      with:
        workflow: ci.yml
        name: frontend-deployment-package
        path: ./frontend-build
        github_token: ${{ secrets.GITHUB_TOKEN }}
        run_id: ${{ github.event.workflow_run.id || '' }}
        if_no_artifact_found: fail

    - name: Verify build artifact
      run: |
        echo "Frontend build contents:"
        ls -lah frontend-build/
        du -sh frontend-build/

    - name: Deploy to Azure Static Web Apps
      id: deploy-static
      uses: Azure/static-web-apps-deploy@v1
      with:
        azure_static_web_apps_api_token: ${{ steps.get-swa-token.outputs.token }}
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        action: "upload"
        app_location: "frontend-build"
        output_location: ""
        skip_app_build: true

    - name: Deployment Summary
      run: |
        echo "### üöÄ Frontend Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Environment**: ${{ github.event.inputs.environment || 'production' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Static Web App**: Deployed to Azure Static Web Apps" >> $GITHUB_STEP_SUMMARY
        echo "- **URL**: https://${{ needs.deploy-infrastructure.outputs.staticWebAppUrl }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "‚úÖ Frontend deployment completed successfully!" >> $GITHUB_STEP_SUMMARY

  notify-deployment:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [deploy-infrastructure, deploy-backend, deploy-frontend]
    if: always()

    steps:
    - name: Deployment Success Notification
      if: needs.deploy-backend.result == 'success' && needs.deploy-frontend.result == 'success'
      run: |
        echo "‚úÖ Full deployment succeeded!"
        echo "Environment: ${{ github.event.inputs.environment || 'production' }}"
        echo "Backend: ${{ needs.deploy-infrastructure.outputs.webAppUrl }}"
        echo "Frontend: https://${{ needs.deploy-infrastructure.outputs.staticWebAppUrl }}"
        echo "Commit: ${{ github.sha }}"

    - name: Deployment Failure Notification
      if: needs.deploy-backend.result == 'failure' || needs.deploy-frontend.result == 'failure'
      run: |
        echo "‚ùå Deployment failed!"
        echo "Backend: ${{ needs.deploy-backend.result }}"
        echo "Frontend: ${{ needs.deploy-frontend.result }}"
        echo "Environment: ${{ github.event.inputs.environment || 'production' }}"
        echo "Commit: ${{ github.sha }}"
        exit 1