name: Frontend CD - Deploy to Azure Static Web App

on:
  push:
    branches: [ main ]
    paths:
      - 'client/**'
      - '.github/workflows/cd-frontend.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  build-and-deploy-frontend:
    name: Build and Deploy Frontend
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.event.inputs.environment || 'production' }}

    defaults:
      run:
        working-directory: ./client

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: true

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'
        cache-dependency-path: client/package-lock.json

    - name: Install dependencies
      run: npm ci

    - name: Create .env.production
      run: |
        echo "REACT_APP_API_URL=${{ secrets.REACT_APP_API_URL }}" > .env.production
        echo "REACT_APP_ENVIRONMENT=production" >> .env.production
        if [ -n "${{ secrets.REACT_APP_APPINSIGHTS_KEY }}" ]; then
          echo "REACT_APP_APPINSIGHTS_INSTRUMENTATION_KEY=${{ secrets.REACT_APP_APPINSIGHTS_KEY }}" >> .env.production
        fi

    - name: Build application
      run: npm run build
      env:
        CI: true
        REACT_APP_API_URL: ${{ secrets.REACT_APP_API_URL }}
        REACT_APP_APPINSIGHTS_INSTRUMENTATION_KEY: ${{ secrets.REACT_APP_APPINSIGHTS_KEY }}
        REACT_APP_ENVIRONMENT: production
        GENERATE_SOURCEMAP: false

    - name: Run post-build optimizations
      run: |
        echo "Build size before optimization:"
        du -sh build/

        # Remove source maps if they exist (extra safety)
        find build -name "*.map" -type f -delete

        # List largest files
        echo "Largest files in build:"
        find build -type f -exec du -h {} + | sort -rh | head -n 10

        echo "Build size after optimization:"
        du -sh build/

    - name: Deploy to Azure Static Web Apps
      id: deploy-static
      uses: Azure/static-web-apps-deploy@v1
      with:
        azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        action: "upload"
        app_location: "/client"
        output_location: "build"
        skip_app_build: true

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: frontend-production-build
        path: client/build/
        retention-days: 30

    - name: Deployment Summary
      run: |
        echo "### üöÄ Frontend Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Environment**: ${{ github.event.inputs.environment || 'production' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Static Web App**: Deployed to Azure Static Web Apps" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "‚úÖ Frontend deployment completed successfully!" >> $GITHUB_STEP_SUMMARY

  # Alternative deployment to Azure Blob Storage (Static Website)
  deploy-to-blob-storage:
    name: Deploy to Azure Blob Storage (Alternative)
    runs-on: ubuntu-latest
    if: false  # Set to true to enable blob storage deployment
    environment:
      name: ${{ github.event.inputs.environment || 'production' }}

    defaults:
      run:
        working-directory: ./client

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'
        cache-dependency-path: client/package-lock.json

    - name: Install dependencies
      run: npm ci

    - name: Build application
      run: npm run build
      env:
        CI: true
        REACT_APP_API_URL: ${{ secrets.REACT_APP_API_URL }}
        GENERATE_SOURCEMAP: false

    - name: Login to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Upload to Blob Storage
      run: |
        az storage blob upload-batch \
          --account-name ${{ secrets.AZURE_STORAGE_ACCOUNT }} \
          --auth-mode key \
          --destination '$web' \
          --source ./build \
          --overwrite true

    - name: Purge CDN endpoint (if configured)
      run: |
        if [ -n "${{ secrets.AZURE_CDN_ENDPOINT }}" ]; then
          az cdn endpoint purge \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --profile-name ${{ secrets.AZURE_CDN_PROFILE }} \
            --name ${{ secrets.AZURE_CDN_ENDPOINT }} \
            --content-paths '/*'
        else
          echo "No CDN configured, skipping purge"
        fi
      continue-on-error: true

    - name: Logout from Azure
      run: az logout
      if: always()

  notify-deployment:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: build-and-deploy-frontend
    if: always()

    steps:
    - name: Deployment Success Notification
      if: needs.build-and-deploy-frontend.result == 'success'
      run: |
        echo "‚úÖ Frontend deployment succeeded!"
        echo "Environment: ${{ github.event.inputs.environment || 'production' }}"
        echo "Commit: ${{ github.sha }}"

    - name: Deployment Failure Notification
      if: needs.build-and-deploy-frontend.result == 'failure'
      run: |
        echo "‚ùå Frontend deployment failed!"
        echo "Environment: ${{ github.event.inputs.environment || 'production' }}"
        echo "Commit: ${{ github.sha }}"
        exit 1
