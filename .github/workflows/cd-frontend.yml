name: CricketTeamExpenseApp-Frontend CD - Deploy to Azure Static Web App

on:
  workflow_run:
    workflows: ["CricketTeamExpenseApp-CI"]
    types:
      - completed
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  deploy-frontend:
    name: Deploy Frontend to Azure Static Web App
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    environment:
      name: ${{ github.event.inputs.environment || 'production' }}

    steps:
    - name: Download frontend deployment artifact
      uses: dawidd6/action-download-artifact@v3
      with:
        workflow: ci.yml
        name: frontend-deployment-package
        path: ./frontend-build
        github_token: ${{ secrets.GITHUB_TOKEN }}
        run_id: ${{ github.event.workflow_run.id }}
        if_no_artifact_found: fail

    - name: Verify build artifact
      run: |
        echo "Frontend build contents:"
        ls -lah frontend-build/
        du -sh frontend-build/

    - name: Deploy to Azure Static Web Apps
      id: deploy-static
      uses: Azure/static-web-apps-deploy@v1
      with:
        azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        action: "upload"
        app_location: "frontend-build"
        output_location: ""
        skip_app_build: true

    - name: Deployment Summary
      run: |
        echo "### üöÄ Frontend Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Environment**: ${{ github.event.inputs.environment || 'production' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Static Web App**: Deployed to Azure Static Web Apps" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "‚úÖ Frontend deployment completed successfully!" >> $GITHUB_STEP_SUMMARY

  notify-deployment:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: deploy-frontend
    if: always()

    steps:
    - name: Deployment Success Notification
      if: needs.deploy-frontend.result == 'success'
      run: |
        echo "‚úÖ Frontend deployment succeeded!"
        echo "Environment: ${{ github.event.inputs.environment || 'production' }}"
        echo "Commit: ${{ github.sha }}"

    - name: Deployment Failure Notification
      if: needs.deploy-frontend.result == 'failure'
      run: |
        echo "‚ùå Frontend deployment failed!"
        echo "Environment: ${{ github.event.inputs.environment || 'production' }}"
        echo "Commit: ${{ github.sha }}"
        exit 1