name: Backend CD - Deploy to Azure

on:
  push:
    branches: [ main ]
    paths:
      - 'server/**'
      - '.github/workflows/cd-backend.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  deploy-backend:
    name: Deploy Backend to Azure Web App
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.event.inputs.environment || 'production' }}
      url: ${{ steps.deploy.outputs.webapp-url }}

    defaults:
      run:
        working-directory: ./server

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'
        cache-dependency-path: server/package-lock.json

    - name: Install dependencies
      run: npm ci --production

    - name: Create .env file
      run: |
        echo "NODE_ENV=production" > .env
        echo "DB_TYPE=mssql" >> .env
        echo "LOGGING_TYPE=applicationInsights" >> .env
      env:
        NODE_ENV: production

    - name: Run database migrations (if any)
      run: |
        if [ -f "migrations/run-migrations.js" ]; then
          echo "Running migrations..."
          node migrations/run-migrations.js
        else
          echo "No migrations to run"
        fi
      continue-on-error: true

    - name: Create deployment package
      run: |
        cd ..
        zip -r deploy.zip server/ \
          -x "server/node_modules/*" \
          -x "server/*.db" \
          -x "server/*.db-journal" \
          -x "server/.env.local" \
          -x "server/package-lock.json"
        mv deploy.zip server/

    - name: Login to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Deploy to Azure Web App
      id: deploy
      uses: azure/webapps-deploy@v2
      with:
        app-name: ${{ secrets.AZURE_WEBAPP_NAME }}
        package: ./server/deploy.zip

    - name: Configure App Settings
      uses: azure/appservice-settings@v1
      with:
        app-name: ${{ secrets.AZURE_WEBAPP_NAME }}
        app-settings-json: |
          [
            {
              "name": "NODE_ENV",
              "value": "production",
              "slotSetting": false
            },
            {
              "name": "DB_TYPE",
              "value": "mssql",
              "slotSetting": false
            },
            {
              "name": "AZURE_SQL_SERVER",
              "value": "${{ secrets.AZURE_SQL_SERVER }}",
              "slotSetting": false
            },
            {
              "name": "AZURE_SQL_DATABASE",
              "value": "${{ secrets.AZURE_SQL_DATABASE }}",
              "slotSetting": false
            },
            {
              "name": "AZURE_SQL_USER",
              "value": "${{ secrets.AZURE_SQL_USER }}",
              "slotSetting": false
            },
            {
              "name": "AZURE_SQL_PASSWORD",
              "value": "${{ secrets.AZURE_SQL_PASSWORD }}",
              "slotSetting": false
            },
            {
              "name": "JWT_SECRET",
              "value": "${{ secrets.JWT_SECRET }}",
              "slotSetting": false
            },
            {
              "name": "APPINSIGHTS_INSTRUMENTATION_KEY",
              "value": "${{ secrets.APPINSIGHTS_INSTRUMENTATION_KEY }}",
              "slotSetting": false
            },
            {
              "name": "APPLICATIONINSIGHTS_CONNECTION_STRING",
              "value": "${{ secrets.APPLICATIONINSIGHTS_CONNECTION_STRING }}",
              "slotSetting": false
            },
            {
              "name": "LOGGING_TYPE",
              "value": "applicationInsights",
              "slotSetting": false
            },
            {
              "name": "WEBSITE_NODE_DEFAULT_VERSION",
              "value": "~18",
              "slotSetting": false
            }
          ]

    - name: Restart Web App
      run: |
        az webapp restart \
          --name ${{ secrets.AZURE_WEBAPP_NAME }} \
          --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }}

    - name: Health Check
      run: |
        echo "Waiting for app to start..."
        sleep 30

        HEALTH_URL="https://${{ secrets.AZURE_WEBAPP_NAME }}.azurewebsites.net/api/summary"

        for i in {1..5}; do
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" $HEALTH_URL || echo "000")
          echo "Health check attempt $i: HTTP $HTTP_STATUS"

          if [ "$HTTP_STATUS" = "200" ] || [ "$HTTP_STATUS" = "401" ]; then
            echo "‚úÖ Application is healthy!"
            exit 0
          fi

          sleep 10
        done

        echo "‚ö†Ô∏è Health check did not return expected status"
        exit 0
      continue-on-error: true

    - name: Logout from Azure
      run: az logout
      if: always()

    - name: Deployment Summary
      run: |
        echo "### üöÄ Backend Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Environment**: ${{ github.event.inputs.environment || 'production' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **App Name**: ${{ secrets.AZURE_WEBAPP_NAME }}" >> $GITHUB_STEP_SUMMARY
        echo "- **URL**: ${{ steps.deploy.outputs.webapp-url }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "‚úÖ Deployment completed successfully!" >> $GITHUB_STEP_SUMMARY

  notify-deployment:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: deploy-backend
    if: always()

    steps:
    - name: Deployment Success Notification
      if: needs.deploy-backend.result == 'success'
      run: |
        echo "‚úÖ Backend deployment succeeded!"
        echo "Environment: ${{ github.event.inputs.environment || 'production' }}"
        echo "Commit: ${{ github.sha }}"

    - name: Deployment Failure Notification
      if: needs.deploy-backend.result == 'failure'
      run: |
        echo "‚ùå Backend deployment failed!"
        echo "Environment: ${{ github.event.inputs.environment || 'production' }}"
        echo "Commit: ${{ github.sha }}"
        exit 1
